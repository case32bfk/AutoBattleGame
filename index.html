<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#e74c3c">
    <title>Auto Battle Game</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="datas/css/common.css">
    <link id="page-css" rel="stylesheet" href="datas/css/Start.css">
</head>
<body>
    <div id="loading-screen">
        <div class="loading-content">
            <h1>Auto Battle Game</h1>
            <div class="loading-bar-container">
                <div class="loading-bar" id="loading-progress-bar"></div>
            </div>
            <p class="loading-status" id="loading-status">載入中...</p>
        </div>
    </div>

    <div id="app">
        <div id="game-container">
        </div>
    </div>

    <input type="file" id="file-input" accept=".json" style="display: none;">
    <button id="btn-dev" style="display: none;">Dev</button>

    <script>
        var BASE_PATH = '';
    </script>
    
    <script src="datas/SpriteAnimator.js"></script>
    <script src="datas/gameData.js"></script>
    <script src="datas/game.js"></script>
    <script src="datas/battle-system.js"></script>
    <script src="datas/Router.js"></script>
    <script src="datas/pages/StartPage.js"></script>
    <script src="datas/pages/TrainingPage.js"></script>
    <script src="datas/pages/BattlePage.js"></script>
    <script src="datas/pages/SystemPage.js"></script>
    
    <script>
        const PageManager = {
            currentPage: null,
            cssLinks: {
                'start': 'datas/css/Start.css',
                'training': 'datas/css/Training.css',
                'battle': 'datas/css/Battle.css',
                'system': 'datas/css/System.css'
            },
            
            async loadPage(pageName) {
                const container = document.getElementById('game-container');
                
                this.updateCSS(pageName);
                
                switch(pageName) {
                    case 'start':
                        await StartPage.mount(container);
                        break;
                    case 'training':
                        await TrainingPage.mount(container);
                        break;
                    case 'battle':
                        await BattlePage.mount(container);
                        break;
                    case 'system':
                        await SystemPage.mount(container);
                        break;
                    default:
                        Router.navigate('start');
                }
            },
            
            updateCSS(pageName) {
                const cssLink = document.getElementById('page-css');
                const newHref = this.cssLinks[pageName] || this.cssLinks['start'];
                if (cssLink && cssLink.getAttribute('href') !== newHref) {
                    cssLink.setAttribute('href', newHref);
                }
            }
        };

        window.PageManager = PageManager;
    </script>
    <script>
        async function initSPA() {
            const loadingScreen = document.getElementById('loading-screen');
            const loadingStatus = document.getElementById('loading-status');
            const progressBar = document.getElementById('loading-progress-bar');

            function updateLoadingStatus(status, percent) {
                loadingStatus.textContent = status;
                progressBar.style.width = percent + '%';
            }

            try {
                updateLoadingStatus('載入技能資料...', 20);
                await SkillDataManager.loadAllSkillSystems();
                
                updateLoadingStatus('載入怪物資料...', 40);
                await MonsterDataManager.loadAllMonsterData();
                
                updateLoadingStatus('載入屬性資料...', 50);
                await ElementDataManager.loadElementData();
                
                updateLoadingStatus('載入房間資料...', 60);
                await RoomDataManager.loadRoomData();
                
                updateLoadingStatus('載入食物資料...', 70);
                await FoodDataManager.loadFoodData();
                
                updateLoadingStatus('預載入寵物圖片...', 85);
                const allMonsters = MonsterDataManager.getAllMonsters();
                await SpriteAnimator.preloadAll(allMonsters);
                
                updateLoadingStatus('初始化路由...', 95);

                Router.register('start', {
                    onBeforeEnter: () => PageManager.loadPage('start'),
                    onLeave: () => StartPage && StartPage.unmount && StartPage.unmount()
                });

                Router.register('training', {
                    onBeforeEnter: () => PageManager.loadPage('training'),
                    onLeave: () => TrainingPage && TrainingPage.unmount && TrainingPage.unmount()
                });

                Router.register('battle', {
                    onBeforeEnter: () => PageManager.loadPage('battle'),
                    onLeave: () => BattlePage && BattlePage.unmount && BattlePage.unmount()
                });

                Router.register('system', {
                    onBeforeEnter: () => PageManager.loadPage('system'),
                    onLeave: () => SystemPage && SystemPage.unmount && SystemPage.unmount()
                });

                updateLoadingStatus('啟動遊戲...', 100);
                await new Promise(resolve => setTimeout(resolve, 300));
                
                loadingScreen.style.display = 'none';
                
                StartPage.setReady(true);
                Router.init();
                
                console.log('SPA 初始化完成');
            } catch (error) {
                loadingStatus.textContent = '載入失敗: ' + error.message;
                console.error('SPA 初始化失敗:', error);
            }
        }

        initSPA();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>
</body>
</html>
