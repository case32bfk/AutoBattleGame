# AutoBattleGame 專案術語格式書

## 1. 專案概述
- **專案名稱**: Auto Battle Game
- **類型**: 網頁版寵物培養戰鬥遊戲
- **技術堆疊**: HTML / CSS / JavaScript (無框架)

---

## 2. 頁面結構

### 2.1 頁面列表
| 頁面 | 檔案 | 功能說明 |
|------|------|----------|
| 標題頁 | `Start.html` | 遊戲登入/開始畫面 |
| 培養頁 | `scene/Training.html` | 寵物培養與互動 |
| 戰鬥頁 | `scene/Battle.html` | 自動戰鬥系統 |
| 系統頁 | `scene/System.html` | 存檔管理與設定 |

### 2.2 導航按鈕
- **培養**: 通往 `Training.html`
- **狩獵**: 通往 `Battle.html`
- **轉蛋**: 預留功能 (尚未開放)
- **系統**: 通往 `System.html`

---

## 3. 培養頁面術語定義

### 3.1 寵物狀態 (Pet Status)
指寵物的基本數值顯示區塊，包含：
| 術語 | 變數 | 說明 |
|------|------|------|
| Lv | `monster.lv` | 寵物等級，影響屬性成長 |
| 經驗 | `monster.exp` / `monster.expToNextLevel` | 當前經驗值 / 升級所需經驗 |
| 生命 | `monster.hp` / `monster.maxhp` | 當前生命值 / 最大生命值 |

### 3.2 寵物能力 (Pet Stats)
指寵物的戰鬥屬性，包含：
| 術語 | 變數 | 說明 |
|------|------|------|
| 力 | `monster.str` | 決定技能傷害 |
| 智 | `monster.int` | 影響部分技能效果，提高發現稀有道具的機率 |
| 體 | `monster.def` | 影響技能減傷，提高最大生命值 |
| 速 | `monster.dex` | 決定行動順序 |
| 美 | `monster.cha` | 影響進化路線，影響部分技能效果 |

### 3.3 互動項目 (Interactions)
培養頁面的互動按鈕：
| 項目 | 函式 | 消耗 | 效果 |
|------|------|------|------|
| 餵食 | `feedMonster()` | 10 金幣 | 增加飽足度 + 食物效果 |
| 洗澡 | `bathMonster()` | 免費 | 清潔度=100, 增加好感度 |
| 清理 | `toiletMonster()` | 免費 | 清潔度=100, 增加好感度 |
| 互動 | `interactMonster()` | 免費 | 增加經驗值 |

### 3.4 培養資訊 (Training Info)
指寵物的進階培養系統：
| 項目 | 說明 |
|------|------|
| 技能 | 寵物擁有的攻擊技能，透過 `skill_id` 陣列管理 |
| 進化 | 寵物進化為更強形態，透過 `next` 陣列定義進化樹 |
| 房間 | 寵物居住的房間，透過 `roomId` 關聯，可放置多個房間 |

### 3.5 其他培養相關
| 術語 | 說明 |
|------|------|
| 寵物名稱 | `monster.name`，可透過編輯按鈕修改 |
| 屬性 | `monster.element`，最多兩個屬性 [主屬性, 副屬性] |

### 3.6 大便系統
| 術語 | 說明 |
|------|------|
| unchiTimer | 大便計時器，每次飽足度減少時增加該值 |
| unchi | 大便數量，當 unchiTimer >= 100 時產生 |
| 清理大便 | 點擊大便圖示清理，獲得 7~15 好感度、10~25 經驗值 |

---

## 4. 戰鬥頁面術語定義

### 4.1 戰鬥角色
| 術語 | 說明 |
|------|------|
| 玩家寵物 | 我方出戰的寵物 (Player Side) |
| 敵方寵物 | 戰鬥對手 (Enemy Side) |

### 4.2 戰鬥動作
| 動作 | 函式 | 說明 |
|------|------|------|
| 攻擊 | 自動執行 | 使用技能攻擊敵人 |
| 防禦 | 自動執行 | 降低下次受到的傷害 |
| 捕捉 | 自動執行 | 嘗試捕捉敵方寵物 (未實裝) |
| 撤退 | `btn-retreat` | 結束戰鬥，返回培養頁 |

### 4.3 戰鬥數值
- **HP**: 生命值歸零則戰鬥失敗
- **暴擊率 (crit_rate)**: 增加暴擊傷害的機率
- **破防 (defBreak)**: 無視敵方防禦的機率

### 4.4 戰鬥技能系統

#### 4.4.1 行動列表
戰鬥開始時，遍尋寵物/怪物的所有技能，並依照use值的大>小來排序技能

#### 4.4.2 行動加藤抽取
寵物/怪物在每次行動開始時，合計所有技能的use值，進行權重加藤抽取(Weighted Random Selection)
- use值為formula時，需依照formula來運算
- 範例: `self.hp<self.mhp*0.25?8:3` 表示該技能的use為3，在自身生命小於25%時use為8

#### 4.4.3 傷害計算
- 目標為self時，視為治療/buff
- 目標為target時，視為傷害/debuff
- 治療/buff/debuff不計算暴擊
- 僅在目標為target，且有傷害公式時，在傷害計算完後，依照行動的屬性與目標的屬性處理屬性效果

#### 4.4.3 戰鬥Log格式
- `[行動者]施展了[技能名稱]`
- `[如果暴擊，顯示擊中要害！]`
- `對[目標]造成[傷害/治療/效果]`

#### 4.4.4 戰鬥結算
- 戰鬥結束時，顯示結算畫面於戰鬥Log位置
- 顯示: 戰鬥結果、獲得經驗值、獲得金幣
- 提供返回培養頁按鈕

#### 4.4.5 屬性效果
- 當目標的strong屬性包含技能的element ID時，視為[目標有耐性]，傷害*25%~50%

---

## 5. 資料結構定義

### 5.1 存檔結構 (SaveData)
存檔分散存儲於多個 localStorage 鍵：
| 鍵名 | 說明 |
|------|------|
| `autoBattleGame_gold` | 金幣數量 |
| `autoBattleGame_monster` | 寵物物件 |
| `autoBattleGame_gameProgress` | 遊戲進度 |
| `autoBattleGame_openRooms` | 已解鎖的房間ID陣列 |

```javascript
{
    gold: Number,           // 金幣數量
    monster: Object,        // 寵物物件
    openRooms: [String],   // 已解鎖的房間ID陣列
    gameProgress: {
        totalBattles: Number,   // 總戰鬥次數
        wins: Number,           // 勝利次數
        losses: Number          // 失敗次數
    }
}
```

### 5.2 寵物結構 (Monster)
```javascript
{
    id: String,             // 怪物ID (如 "slime_001")
    name: String,           // 寵物名稱
    element: [Number, null], // 屬性陣列 [主屬性ID, 副屬性ID]
    image_name: String,     // 圖片檔名
    image_emoji: String,   // 顯示 Emoji
    lv: Number,            // 等級
    exp: Number,           // 當前經驗
    expToNextLevel: Number,// 升級所需經驗
    hp: Number,            // 當前生命
    maxhp: Number,         // 最大生命
    str: Number,           // 力量
    def: Number,           // 體質
    dex: Number,           // 速度
    int: Number,           // 智力
    cha: Number,           // 魅力
    potential: Number,     // 潛力值 (用於覺醒)
    unchiTimer: Number,    // 大便計時器
    unchi: Number,         // 大便數量
    skill_id: [String],    // 技能ID陣列
    room: String,          // 當前設定的房間ID
    feed_reset_time: Number,// 餵食冷卻時間 (時間戳)
    stm: Number,           // 飽足度 (0-100)
    clean: Number,          // 清潔度 (0-100)
    affection_lv: Number,  // 好感度等級
    affection_exp: Number   // 好感度經驗 (滿1000升級)
}
```

### 5.3 怪物資料結構 (MonsterData)
```javascript
{
    id: String,             // 怪物ID
    name: String,           // 怪物名稱
    element: String,        // 屬性 (如 "water", "earth")
    image_name: String,      // 圖片名稱
    base_stats: {            // 基礎屬性
        hp: Number,
        str: Number,
        def: Number,
        dex: Number,
        int: Number,
        cha: Number
    },
    skill_id: String,       // 初始技能ID
    next: [String]          // 進化路線ID陣列
}
```

### 5.4 技能結構 (Skill)
```javascript
{
    id: String,            // 技能ID
    name: String,          // 技能名稱
    formula: String,       // 傷害/治療公式
    element: Number,       // 技能屬性ID (0=火, 1=水, 2=風, 3=雷, 10=斬)
    description: String,   // 完整描述
    brief_description: String, // 簡短描述
    use: String|Number     // 行動權重 (可為數字或條件公式)
}
```

### 5.4.1 技能公式格式 (Skill Formula)
格式: `目標/公式/額外效果`
- **目標**: `target` (攻擊敵人) 或 `self` (治療/buff自己)
- **公式**: 傷害計算式，如 `self.atk * 2 - target.def`
- **額外效果**: 用逗號分隔，如 `cri + 20,against:"mecha"`

範例:
- `target/self.atk * 2 - target.def/cri - 30,against:"cyber"` - 攻擊敵人，2倍ATK減DEF，暴擊率-30%，對cyber種族1.5倍
- `self/self.atk * 0.5/` - 治療自己，恢復50% ATK

### 5.4.2 use權重格式
- **固定數值**: `use: 5`
- **條件公式**: `use: "self.hp<self.mhp*0.25?8:3"` - HP低於25%時use=8，否則use=3

### 5.4.3 額外效果類型
| 效果 | 語法 | 說明 |
|------|------|------|
| 暴擊率 | `cri + 20` | 增加暴擊率20% |
| 暴擊率 | `cri - 30` | 減少暴擊率30% |
| 種族剋制 | `against:"mecha"` | 對指定種族敵人傷害1.5倍 |
| 破防 | `defBreak + 100` | 100%機率無視防禦 |

### 5.5 屬性結構 (Element)
```javascript
{
    element_id: Number,    // 屬性ID
    element_name: String,  // 屬性名稱 (火/水/風/雷)
    element_icon: String  // 屬性圖示 (Emoji或圖片路徑)
}
```

### 5.6 食物資料結構 (Food)
```javascript
{
    id: String,            // 食物ID
    name: String,          // 食物名稱
    image_folder: String,  // 圖片資料夾名稱
    animation_frames: Number, // 動畫幀數
    food_effect: String    // 食物效果 (如 "stm/+/10-20;exp/+/3-10")
}
```

### 5.7 UI 圖示結構 (UI Icon)
- 位置: `datas/images/ui/`
- 尺寸: 16x16 像素為一格
- 使用方式: 透過 `background-position` 定位取得指定 index 的圖示
- 圖示檔案:
  - `element_icons.png`: 屬性與技能圖示

```javascript
// 取得圖示位置
const iconSize = 16;
const x = (index % 16) * iconSize;  // 橫向位置
const y = Math.floor(index / 16) * iconSize;  // 縱向位置
```

### 5.8 技能系統結構 (Skill System)
```javascript
{
    name: String,           // 系統名稱 (如 "斬擊")
    icon: String,          // 圖示檔名 (對應 datas/images/ui/)
    icon_index: Number,    // 圖示索引 (0-based)
    skills: [Skill]        // 技能列表
}
```

### 5.9 房間結構 (Room)
```javascript
{
    roomId: String,       // 房間唯一ID (如 "forest")
    name: String,         // 房間名稱 (如 "森林")
    image: String,        // 房間圖片檔名 (對應 datas/images/rooms/)
    description: String,  // 房間描述
    formula: String       // 房間效果公式 (預留，未實裝)
}
```

---

## 6. 常數與公式

### 6.1 升級公式
- **經驗需求**: `expToNextLevel = Math.floor(expToNextLevel * 1.5)`
- **屬性成長**:
  - HP: `+10`
  - 力: `+3`
  - 體: `+2`
  - 速: `+1`
  - 智: `+1`
  - 美: `+1`

### 6.2 好感度公式
- **好感度等級**: 滿 1000 經驗升一級
- **好感度上限**: 等級無限，但每級需要 1000 經驗

### 6.3 戰鬥屬性計算
- HP: `base_stats.hp * (1 + (level - 1) * 0.1)`
- 力: `base_stats.str * (1 + (level - 1) * 0.08)`
- 體: `base_stats.def * (1 + (level - 1) * 0.08)`
- 速: `base_stats.dex * (1 + (level - 1) * 0.05)`
- 智: `base_stats.int * (1 + (level - 1) * 0.08)`
- 美: `base_stats.cha * (1 + (level - 1) * 0.08)`

### 6.4 傷害公式格式 (新版)
```
目標/公式/額外效果
```
- 目標: `target` 或 `self`
- 公式: 傷害計算式，使用 `self.str`, `target.def` 等變數
- 額外效果: `cri + 20`, `against:"種族"`, `defBreak + 100`

範例:
- `target/self.str*2-target.def/cri+20,against:"mecha"` (新版)
- `damage:攻擊力公式;效果:效果值` (舊版，仍相容)

### 6.5 食物效果格式
```
stat/operator/min-max
```
範例: `stm/+/10-20;exp/+/3-10`
- stat: 屬性名稱 (stm, exp, hp)
- operator: 運算符 (+, -, *, /)
- min-max: 數值範圍

### 6.6 自動遞減
- **每 10 秒**: 50% 機率飽足度減少 1-2
- **每 10 秒**: 50% 機率清潔度減少 1-2

### 6.7 暴擊與種族剋制
- **暴擊**: 3倍傷害
- **種族剋制**: `against:"種族名"` 額外1.5倍傷害
- **屬性耐性**: 目標的strong屬性包含技能element時，傷害降低為25%~50%

### 6.8 戰鬥經驗值計算
```
經驗值 = 敵人LV * 隨機倍率 * 敵人LV / 寵物LV
```
- 隨機倍率: 1.00 ~ 1.50 (包含小數點第二位)
- 計算結果無條件捨去
- 最小值為1

範例:
- 寵物LV10 敵人LV12，隨機倍率1.32: `12 * 1.32 * 12 / 10 = 19.008` → 19
- 寵物LV10 敵人LV2，隨機倍率1.47: `2 * 1.47 * 2 / 10 = 0.588` → 1 (最小值為1)

### 6.9 升級系統

#### 6.9.1 所需經驗值
```
經驗值 = LV * 100 + LV * LV / 2 * 25 (無條件捨去)
```
範例: LV5 = `5*100 + 5*5/2*25 = 812`

#### 6.9.2 能力值提升
- temp_status = 3~7 (隨機)
- 若 temp_status < 7，差額加入 potential
- temp_status 點數隨機分配至 力/智/體/速/美
- 體每加1，maxhp +3

#### 6.9.3 潛力覺醒 (10%機率)
- 觸發時: potential * (0.25~0.4) 點數隨機分配
- 未觸發: potential * (1.1~1.3) 累積至下次

#### 6.9.4 潛力值
- 儲存於 monster.potential
- 用於覺醒時額外獲得能力值

---

## 7. 共通元件

### 7.1 SpriteAnimator - 寵物動畫
```javascript
SpriteAnimator.play(imageElement, baseName, options)
// options: frame1Suffix, frame2Suffix, duration, loopCount, onComplete
```

### 7.2 FoodAnimator - 食物動畫
```javascript
FoodAnimator.show(imageFolder)  // 顯示食物
FoodAnimator.updateFrame(frameIndex)  // 更新幀
FoodAnimator.stop()  // 停止動畫
```

### 7.3 ResultPopup - 結果彈出
```javascript
ResultPopup.show(text)  // 顯示結果文字，自動淡出
```

### 7.4 GoldChangeAnimator - 金幣變化動畫
```javascript
GoldChangeAnimator.show(changeAmount)  // 顯示金幣變化，數字遞減動畫
```

### 7.5 FoodDataManager - 食物資料管理
```javascript
FoodDataManager.loadFoodData()  // 載入食物資料
FoodDataManager.getFoodById(id)  // 取得食物資料
FoodDataManager.getRandomFood()  // 隨機取得食物
```

### 7.6 FoodEffectParser - 食物效果解析
```javascript
FoodEffectParser.parse(effectString)  // 解析效果字串
FoodEffectParser.apply(effects)       // 應用效果
```

---

## 8. 檔案目錄結構

```
AutoBattleGame/
├── Start.html                    # 遊戲標題頁
├── scene/
│   ├── Training.html            # 培養頁面
│   ├── Battle.html              # 戰鬥頁面
│   ├── System.html              # 系統頁面
│   └── css/
│       ├── common.css           # 共用樣式
│       ├── Training.css        # 培養頁樣式
│       ├── Battle.css          # 戰鬥頁樣式
│       └── System.css          # 系統頁樣式
├── datas/
│   ├── gameData.js             # 資料管理模組
│   ├── game.js                 # 遊戲邏輯模組
│   ├── element.json            # 屬性資料
│   ├── foodIndex.json         # 食物資料
│   ├── monsterDatas/           # 怪物資料庫
│   │   ├── index.json
│   │   └── slime.json
│   ├── skillDatas/            # 技能資料庫
│   │   ├── index.json
│   │   ├── slash.json
│   │   └── fire.json
│   ├── rooms/                  # 房間資料庫
│   │   └── index.json
│   └── images/
│       ├── monster/            # 怪物圖片 (1格96x96)
│       │   └── [name]/
│       │       ├── [name]_1.png  # 待機動畫
│       │       └── [name]_2.png  # 動作動畫
│       ├── food/               # 食物圖片
│       │   └── [folder]/
│       │       └── [folder]_[n].png
│       ├── rooms/              # 房間圖片
│       └── ui/                # UI 圖示 (16x16 sprite)
└── service-worker.js          # PWA 快取服務
```

---

## 9. 資料管理模組

### 9.1 MonsterDataManager
- `loadMonsterData(filename)`: 載入怪物資料
- `loadAllMonsterData()`: 載入所有怪物
- `getMonsterById(id)`: 取得怪物資料
- `calculateStats(id, level)`: 計算戰鬥屬性
- `getEvolutionTree(id)`: 取得進化樹

### 9.2 SkillDataManager
- `loadSkillSystem(filename)`: 載入技能系統
- `getSkillById(id)`: 取得技能資料
- `parseFormula(formula)`: 解析傷害公式

### 9.3 ElementDataManager
- `loadElementData()`: 載入屬性資料
- `getElementById(id)`: 取得屬性資料

### 9.4 RoomDataManager
- `loadRoomData()`: 載入房間資料
- `getRoomById(roomId)`: 取得房間資料
- `getAllRooms()`: 取得所有房間列表
- `getRoomName(roomId)`: 取得房間名稱

### 9.5 FoodDataManager
- `loadFoodData()`: 載入食物資料
- `getFoodById(id)`: 取得食物資料
- `getRandomFood()`: 隨機取得食物

### 9.6 前端技能顯示函式
- `showSkillsModal()`: 顯示技能列表 Modal
- `getSkillIconUrl(skill)`: 取得技能圖示 URL 與位置資訊

### 9.7 前端房間顯示函式
- `showRoomModal()`: 顯示房間設置 Modal

### 9.8 遊戲邏輯函式
- `checkLevelUp(monster)`: 檢查升級
- `checkAffectionLevelUp(monster)`: 檢查好感度升級
- `addAffection(monster, amount)`: 增加好感度
- `decreaseStmAndClean(monster)`: 減少飽足度和清潔度

### 9.9 BattleSystem 戰鬥系統
- `init(callback)`: 初始化戰鬥系統
- `startBattle(playerMonster, enemyMonster)`: 開始戰鬥
- `onPlayerAttack()`: 玩家攻擊
- `onPlayerDefend()`: 玩家防禦
- `setAutoMode(enabled)`: 設定自動模式
- `isBattleOver()`: 檢查戰鬥是否結束
- `updateBattleUI()`: 更新戰鬥UI

---

## 10. 版本資訊
- **建立日期**: 2026-02-21
- **專案狀態**: 開發中
- **v1.1 更新**: 新增戰鬥技能系統 - 加權隨機抽取行動、屬性效果、暴擊與種族剋制
- **v1.2 更新**: 新增戰鬥Log格式、戰鬥結算畫面、新版經驗值計算公式
- **v1.3 更新**: 寵物能力值名稱變更 - atk→力, def→體, speed→速, 新增智、美
- **v1.4 更新**: 新增升級系統 - 所需經驗值公式、潛力值、潛力覺醒機制、升級提示UI
- **v1.5 更新**: 新增大便系統 - unchiTimer、unchi計數、清理大便獲得獎勵
