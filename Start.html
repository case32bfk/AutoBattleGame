<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#e94560">
    <meta name="viewport" content="width=430, height=932, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auto Battle Game</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="scene/css/common.css">
    <link rel="stylesheet" href="scene/css/Start.css">
</head>
<body>
    <div id="game-container">
        <div id="loading-screen">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h2>載入中...</h2>
                <p id="loading-status">初始化...</p>
                <div class="loading-progress">
                    <div class="loading-progress-bar" id="loading-progress-bar"></div>
                </div>
            </div>
        </div>
        <div id="title-screen" style="display: none;">
            <h1>自動戰鬥遊戲</h1>
            <div class="content-container">
                <div class="menu-buttons">
                    <button id="btn-start">開始遊戲</button>
                    <button id="btn-load">讀取存檔</button>
                    <button id="btn-save">輸出存檔</button>
                    <button id="btn-dev" style="background-color: #666; display: none;">Dev - 檢查存檔</button>
                </div>
            </div>
        </div>
        <input type="file" id="file-input" accept=".json" style="display: none;">
    </div>
    <script src="datas/gameData.js"></script>
    <script src="datas/game.js"></script>
    <script>
        let isGameReady = false;

        async function initGame() {
            const loadingScreen = document.getElementById('loading-screen');
            const titleScreen = document.getElementById('title-screen');
            const loadingStatus = document.getElementById('loading-status');
            const progressBar = document.getElementById('loading-progress-bar');

            function updateLoadingStatus(status, percent) {
                loadingStatus.textContent = status;
                progressBar.style.width = percent + '%';
            }

            try {
                updateLoadingStatus('載入技能資料...', 20);
                await SkillDataManager.loadAllSkillSystems();
                
                updateLoadingStatus('載入怪物資料...', 50);
                await MonsterDataManager.loadAllMonsterData();
                
                updateLoadingStatus('初始化遊戲系統...', 80);
                
                updateLoadingStatus('載入完成！', 100);
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                loadingScreen.style.display = 'none';
                titleScreen.style.display = 'flex';
                isGameReady = true;
                
                console.log('遊戲初始化完成');
            } catch (error) {
                loadingStatus.textContent = '載入失敗: ' + error.message;
                console.error('遊戲初始化失敗:', error);
            }
        }

        document.getElementById('btn-start').addEventListener('click', function() {
            if (!isGameReady) {
                alert('遊戲尚未載入完成，請稍後再試');
                return;
            }
            if (!checkSaveExists()) {
                initSaveData();
            }
            window.location.href = 'scene/Training.html';
        });

        document.getElementById('btn-load').addEventListener('click', function() {
            if (!isGameReady) {
                alert('遊戲尚未載入完成，請稍後再試');
                return;
            }
            document.getElementById('file-input').click();
        });

        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                importSaveData(file, function(data) {
                    alert('存檔載入成功！\n金幣: ' + data.gold);
                });
            }
        });

        document.getElementById('btn-save').addEventListener('click', function() {
            if (!isGameReady) {
                alert('遊戲尚未載入完成，請稍後再試');
                return;
            }
            if (!checkSaveExists()) {
                alert('沒有可輸出的存檔');
                return;
            }
            exportSaveData();
            alert('存檔已輸出');
        });

        document.getElementById('btn-dev').addEventListener('click', function() {
            if (checkSaveExists()) {
                const data = getSaveData();
                alert('存檔存在！\n金幣: ' + data.gold);
            } else {
                alert('存檔不存在');
            }
        });

        window.devmode = function() {
            document.getElementById('btn-dev').style.display = 'block';
            console.log('Dev mode enabled');
        };

        window.display_all_monsterData = function() {
            console.log('========== 怪物資料 ==========');
            const monsters = MonsterDataManager.getAllMonsters();
            monsters.forEach(monster => {
                console.log(JSON.stringify(monster, null, 2));
                console.log('---');
            });
            console.log('========== 共 ' + monsters.length + ' 隻怪物 ==========');
        };

        initGame();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>
</body>
</html>
