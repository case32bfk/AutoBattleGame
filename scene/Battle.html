<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#e94560">
    <title>Êà∞È¨• - Auto Battle Game</title>
    <link rel="manifest" href="../manifest.json">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/Battle.css">
</head>
<body>
    <div id="game-container">
        <div id="battle-screen">
            <div class="screen-header">
                <h2>Êà∞È¨•</h2>
                <div class="gold-display" style="display: none;">üí∞ <span id="gold-count" class="gold-current">0</span></div>
            </div>
            <div class="battle-field">
                <div class="enemy-side">
                    <div id="enemy-monster">
                        <div class="battle-image" id="enemy-image">
                            <div class="room-background"></div>
                            <div class="monster-sprite"></div>
                        </div>
                        <div class="battle-status" id="enemy-status">
                            <div class="status-name" id="enemy-name">---</div>
                            <div class="status-lv">Lv.<span id="enemy-lv">1</span></div>
                            <div class="status-hp">
                                <span class="hp-label">HP</span>
                                <span id="enemy-hp">0</span> / <span id="enemy-max-hp">0</span>
                            </div>
                            <div class="status-stats">
                                <span class="stat-atk">Âäõ <span id="enemy-str">0</span></span>
                                <span class="stat-int">Êô∫ <span id="enemy-int">0</span></span>
                                <span class="stat-def">È´î <span id="enemy-def">0</span></span>
                                <span class="stat-speed">ÈÄü <span id="enemy-dex">0</span></span>
                                <span class="stat-cha">Áæé <span id="enemy-cha">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="player-side">
                    <div id="player-monster">
                        <div class="battle-image" id="player-image">
                            <div class="room-background"></div>
                            <div class="monster-sprite"></div>
                        </div>
                        <div class="battle-status" id="player-status">
                            <div class="status-name" id="player-name">---</div>
                            <div class="status-lv">Lv.<span id="player-lv">1</span></div>
                            <div class="status-hp">
                                <span class="hp-label">HP</span>
                                <span id="player-hp">0</span> / <span id="player-max-hp">0</span>
                            </div>
                            <div class="status-stats">
                                <span class="stat-atk">Âäõ <span id="player-str">0</span></span>
                                <span class="stat-int">Êô∫ <span id="player-int">0</span></span>
                                <span class="stat-def">È´î <span id="player-def">0</span></span>
                                <span class="stat-speed">ÈÄü <span id="player-dex">0</span></span>
                                <span class="stat-cha">Áæé <span id="player-cha">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="battle-log" id="battle-log" style="width: 100%;">
            </div>
            <div class="battle-controls">
                <div class="control-label">Êìç‰ΩúÂäüËÉΩ</div>
                <div class="control-buttons">
                    <button id="btn-advance" class="control-btn">ÂâçÈÄ≤</button>
                    <div class="auto-toggle">
                        <span class="toggle-label">Ëá™Âãï</span>
                        <label class="switch">
                            <input type="checkbox" id="btn-auto">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <div id="battle-footer" class="footer-nav">
            <button class="nav-btn" id="nav-training">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">ÂüπÈ§ä</span>
            </button>
            <button class="nav-btn active" id="nav-hunt">
                <span class="nav-icon">‚öîÔ∏è</span>
                <span class="nav-label">Áã©Áçµ</span>
            </button>
            <button class="nav-btn" id="nav-gacha">
                <span class="nav-icon">üéÅ</span>
                <span class="nav-label">ËΩâËõã</span>
            </button>
            <button class="nav-btn" id="nav-system">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">Á≥ªÁµ±</span>
            </button>
        </div>
    </div>
    <button id="btn-dev" style="display: none;">Dev</button>
    <script src="../datas/gameData.js"></script>
    <script src="../datas/game.js"></script>
    <script src="../datas/battle-system.js"></script>
    <script src="components/GameNavigation.js"></script>
    <script>
        async function initBattle() {
            await MapDataManager.loadMaps();
            
            const map = MapDataManager.getRandomMap();
            MapDataManager.setCurrentMap(map);
            
            const data = getSaveData();
            if (!data || !data.monster) {
                alert('Ê≤íÊúâÂØµÁâ©Ë≥áÊñôÔºåË´ãÂÖàÂª∫Á´ãÂ≠òÊ™î');
                window.location.href = 'Training.html';
                return;
            }
            
            updatePlayerDisplay(data.monster);
            
            const enemyMonster = MapDataManager.getRandomMonster(map);
            updateEnemyDisplay(enemyMonster);
            
            BattleSystem.init((event, data) => {
                console.log('Battle event:', event, data);
            });
            
            BattleSystem.startBattle(data.monster, enemyMonster);
        }

        function updatePlayerDisplay(m) {
            document.getElementById('player-name').textContent = m.name || 'Êú™Áü•';
            document.getElementById('player-lv').textContent = m.lv || 1;
            document.getElementById('player-hp').textContent = m.hp || 0;
            document.getElementById('player-max-hp').textContent = m.maxhp || 100;
            document.getElementById('player-str').textContent = m.str || 0;
            document.getElementById('player-int').textContent = m.int || 0;
            document.getElementById('player-def').textContent = m.def || 0;
            document.getElementById('player-dex').textContent = m.dex || 0;
            document.getElementById('player-cha').textContent = m.cha || 0;
            
            const roomId = m.room || 'forest';
            const roomData = RoomDataManager.getRoomById(roomId);
            const playerImageEl = document.querySelector('#player-image .room-background');
            if (roomData && roomData.image && playerImageEl) {
                playerImageEl.style.backgroundImage = `url('/datas/images/rooms/${roomData.image}.png')`;
            }
            
            const playerSprite = document.querySelector('#player-image .monster-sprite');
            const playerMonsterData = MonsterDataManager.getMonsterById(m.id);
            if (playerMonsterData && playerMonsterData.image_name) {
                playerSprite.innerHTML = `<img src="/datas/images/monster/${playerMonsterData.image_name}/${playerMonsterData.image_name}_1.png" alt="${m.name}">`;
            } else if (m.image_emoji) {
                playerSprite.innerHTML = '';
                playerSprite.textContent = m.image_emoji;
            } else if (m.image_name) {
                playerSprite.innerHTML = `<img src="/datas/images/monster/${m.image_name}/${m.image_name}_1.png" alt="${m.name}">`;
            } else {
                playerSprite.innerHTML = '';
                playerSprite.textContent = 'üêâ';
            }
        }

        function updateEnemyDisplay(enemyMonster) {
            if (!enemyMonster) return;
            
            document.getElementById('enemy-name').textContent = enemyMonster.name || 'Êïµ‰∫∫';
            document.getElementById('enemy-lv').textContent = enemyMonster.lv || 1;
            document.getElementById('enemy-hp').textContent = enemyMonster.hp || 0;
            document.getElementById('enemy-max-hp').textContent = enemyMonster.maxhp || 100;
            document.getElementById('enemy-str').textContent = enemyMonster.str || 0;
            document.getElementById('enemy-int').textContent = enemyMonster.int || 0;
            document.getElementById('enemy-def').textContent = enemyMonster.def || 0;
            document.getElementById('enemy-dex').textContent = enemyMonster.dex || 0;
            document.getElementById('enemy-cha').textContent = enemyMonster.cha || 0;
            
            const map = MapDataManager.getCurrentMap();
            const roomId = map ? 'forest' : 'forest';
            const enemyRoomData = RoomDataManager.getRoomById(roomId);
            const enemyImageEl = document.querySelector('#enemy-image .room-background');
            if (enemyRoomData && enemyRoomData.image && enemyImageEl) {
                enemyImageEl.style.backgroundImage = `url('/datas/images/rooms/${enemyRoomData.image}.png')`;
            }
            
            const enemySprite = document.querySelector('#enemy-image .monster-sprite');
            const enemyMonsterData = MonsterDataManager.getMonsterById(enemyMonster.id);
            if (enemyMonsterData && enemyMonsterData.image_name) {
                enemySprite.innerHTML = `<img src="/datas/images/monster/${enemyMonsterData.image_name}/${enemyMonsterData.image_name}_1.png" alt="${enemyMonster.name}">`;
            } else if (enemyMonster.image_emoji) {
                enemySprite.innerHTML = '';
                enemySprite.textContent = enemyMonster.image_emoji;
            } else if (enemyMonster.image_name) {
                enemySprite.innerHTML = `<img src="/datas/images/monster/${enemyMonster.image_name}/${enemyMonster.image_name}_1.png" alt="${enemyMonster.name}">`;
            } else {
                enemySprite.innerHTML = '';
                enemySprite.textContent = 'üëæ';
            }
            
            window.currentEnemy = enemyMonster;
        }

        document.getElementById('btn-advance').addEventListener('click', function() {
            BattleSystem.onPlayerAdvance();
        });

        document.getElementById('btn-auto').addEventListener('change', function(e) {
            BattleSystem.setAutoMode(e.target.checked);
        });

        document.getElementById('nav-training').addEventListener('click', function() {
            window.location.href = 'Training.html';
        });

        document.getElementById('nav-hunt').addEventListener('click', function() {
            window.location.href = 'Battle.html';
        });

        document.getElementById('nav-gacha').addEventListener('click', function() {
            alert('ËΩâËõãÂäüËÉΩÂ∞öÊú™ÈñãÊîæ');
        });

        document.getElementById('nav-system').addEventListener('click', function() {
            window.location.href = 'System.html';
        });

        document.getElementById('btn-dev').addEventListener('click', function() {
            if (checkSaveExists()) {
                const data = getSaveData();
                alert('Â≠òÊ™îÂ≠òÂú®ÔºÅ\nÈáëÂπ£: ' + data.gold);
            } else {
                alert('Â≠òÊ™î‰∏çÂ≠òÂú®');
            }
        });

        window.devmode = function() {
            document.getElementById('btn-dev').style.display = 'block';
            console.log('Dev mode enabled');
        };

        initGameData().then(() => { 
            initBattle();
            GameNavigation.init('Battle');
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('../service-worker.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>
</body>
</html>
