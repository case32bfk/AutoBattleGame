<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#e74c3c">
    <title>ÂüπÈ§äÊÄ™Áç∏ - Auto Battle Game</title>
    <link rel="manifest" href="../manifest.json">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/Training.css">
</head>
<body>
    <div id="game-container">
        <div id="training-screen">
            <div class="screen-header">
                <h2>ÂüπÈ§ä</h2>
                <div class="gold-display">üí∞ <span id="gold-count" class="gold-current">0</span></div>
            </div>
            <div class="training-content">
                <div class="monster-info">
                    <div class="name-edit-container">
                        <span id="monster-name">Â∞èÁÅ´Èæç</span>
                        <button id="btn-edit-name" class="edit-btn">‚úèÔ∏è</button>
                    </div>
                    <div class="monster-image" id="monster-image">
                        <div class="room-background"></div>
                        <div class="monster-sprite"></div>
                        <div class="element-ribbon element-ribbon-top-left" id="element-ribbon-1"></div>
                        <div class="element-ribbon element-ribbon-bottom-right" id="element-ribbon-2"></div>
                    </div>
                    <div class="status-row">
                        <div class="affection-container">
                            <span class="affection-label">‚ô•<span id="monster-affection-lv">1</span></span>
                            <span class="level-label"> Lv.<span id="monster-level">1</span></span>
                        </div>
                        <div class="exp-container">
                            <span class="exp-label">Á∂ìÈ©ó</span>
                            <div class="exp-gauge-container">
                                <div class="exp-bar" id="exp-bar" style="width: 0%;"></div>
                                <span class="exp-text"><span id="monster-exp">0</span>/<span id="monster-exp-max">100</span></span>
                            </div>
                        </div>
                        <div class="hp-container">
                            <span class="hp-label">ÁîüÂëΩ</span>
                            <div class="hp-gauge-container">
                                <div class="hp-bar" id="hp-bar" style="width: 100%;"></div>
                                <span class="hp-text"><span id="monster-hp">100</span>/<span id="monster-max-hp">100</span></span>
                            </div>
                        </div>
                        <div class="status-sub-row">
                            <div class="stm-container">
                                <span class="stm-label">È£ΩË∂≥</span>
                                <div class="stm-gauge-container">
                                    <div class="stm-bar" id="stm-bar" style="width: 100%;"></div>
                                    <span class="stm-text"><span id="monster-stm">100</span>/100</span>
                                </div>
                            </div>
                            <div class="clean-container">
                                <span class="clean-label">Ê∏ÖÊΩî</span>
                                <div class="clean-gauge-container">
                                    <div class="clean-bar" id="clean-bar" style="width: 100%;"></div>
                                    <span class="clean-text"><span id="monster-clean">100</span>/100</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button id="btn-feed"><span class="btn-icon">üçñ</span><span class="btn-text">È§µÈ£ü</span></button>
                        <button id="btn-bath"><span class="btn-icon">üßº</span><span class="btn-text">Ê¥óÊæ°</span></button>
                        <button id="btn-clean"><span class="btn-icon">üßπ</span><span class="btn-text">Ê∏ÖÁêÜ</span></button>
                        <button id="btn-interact"><span class="btn-icon">üí¨</span><span class="btn-text">‰∫íÂãï</span></button>
                    </div>
                    <div class="stats-row">
                        <div class="stat-box">
                            <span class="stat-label">Âäõ</span>
                            <span class="stat-value" id="monster-str">15</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Êô∫</span>
                            <span class="stat-value" id="monster-int">8</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">È´î</span>
                            <span class="stat-value" id="monster-def">10</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">ÈÄü</span>
                            <span class="stat-value" id="monster-dex">12</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Áæé</span>
                            <span class="stat-value" id="monster-cha">8</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button id="btn-skills"><span class="btn-icon">‚ö°</span><span class="btn-text">ÊäÄËÉΩ</span></button>
                        <button id="btn-evolve"><span class="btn-icon">üîÑ</span><span class="btn-text">ÈÄ≤Âåñ</span></button>
                        <button id="btn-room"><span class="btn-icon">üè†</span><span class="btn-text">ÊàøÈñì</span></button>
                        <button disabled><span class="btn-icon">üîí</span><span class="btn-text">Êú™ÈñãÊîæ</span></button>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-nav">
            <button class="nav-btn active" id="nav-training">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">ÂüπÈ§ä</span>
            </button>
            <button class="nav-btn" id="nav-hunt">
                <span class="nav-icon">‚öîÔ∏è</span>
                <span class="nav-label">Áã©Áçµ</span>
            </button>
            <button class="nav-btn" id="nav-gacha">
                <span class="nav-icon">üéÅ</span>
                <span class="nav-label">ËΩâËõã</span>
            </button>
            <button class="nav-btn" id="nav-system">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">Á≥ªÁµ±</span>
            </button>
        </div>
    </div>
    <button id="btn-dev" style="display: none;">Dev</button>
    <script src="../datas/gameData.js"></script>
    <script src="../datas/game.js"></script>
    <script src="components/GameNavigation.js"></script>
    <script>
        let currentMonsterImageName = null;
        
        let isFirstLoad = true;
        
        function updateMonsterDisplay(isInitial = false) {
            try {
                if (typeof getSaveData !== 'function') {
                    console.warn('getSaveData not loaded yet');
                    return;
                }
            } catch (e) {
                console.warn('getSaveData not available:', e);
                return;
            }
            
            const data = getSaveData();
            
            document.getElementById('gold-count').textContent = data ? (data.gold || 0) : 0;
            
            if (!data || !data.monster) {
                document.getElementById('monster-name').textContent = '---';
                document.getElementById('monster-level').textContent = '---';
                document.getElementById('monster-exp').textContent = '---';
                document.getElementById('monster-exp-max').textContent = '---';
                document.getElementById('monster-hp').textContent = '---';
                document.getElementById('monster-max-hp').textContent = '---';
                document.getElementById('monster-str').textContent = '---';
                document.getElementById('monster-def').textContent = '---';
                document.getElementById('monster-dex').textContent = '---';
                document.getElementById('monster-int').textContent = '---';
                document.getElementById('monster-cha').textContent = '---';
                document.getElementById('monster-affection-lv').textContent = '---';
                document.getElementById('monster-stm').textContent = '---';
                document.getElementById('monster-clean').textContent = '---';
                document.getElementById('hp-bar').style.width = '0%';
                document.getElementById('exp-bar').style.width = '0%';
                document.getElementById('stm-bar').style.width = '0%';
                document.getElementById('clean-bar').style.width = '0%';
                document.querySelector('.monster-image .room-background').style.backgroundImage = '';
                const noDataSprite = document.querySelector('.monster-image .monster-sprite');
                noDataSprite.innerHTML = '';
                noDataSprite.textContent = '‚ùì';
                currentMonsterImageName = null;
                document.getElementById('element-ribbon-1').innerHTML = '';
                document.getElementById('element-ribbon-2').innerHTML = '';
                return;
            }
            
            const m = data.monster;
            document.getElementById('monster-name').textContent = m.name || 'Êú™Áü•';
            document.getElementById('monster-level').textContent = m.lv || 1;
            document.getElementById('monster-exp').textContent = m.exp || 0;
            document.getElementById('monster-exp-max').textContent = m.expToNextLevel || 100;
            document.getElementById('monster-hp').textContent = m.hp || 0;
            document.getElementById('monster-max-hp').textContent = m.maxhp || 100;
            document.getElementById('monster-str').textContent = m.str || 0;
            document.getElementById('monster-def').textContent = m.def || 0;
            document.getElementById('monster-dex').textContent = m.dex || 0;
            document.getElementById('monster-int').textContent = m.int || 0;
            document.getElementById('monster-cha').textContent = m.cha || 0;
            
            document.getElementById('monster-affection-lv').textContent = m.affection_lv || 1;
            document.getElementById('monster-stm').textContent = m.stm || 100;
            document.getElementById('monster-clean').textContent = m.clean || 100;
            
            const stmPercent = (m.stm || 100);
            document.getElementById('stm-bar').style.width = stmPercent + '%';
            
            const cleanPercent = (m.clean || 100);
            document.getElementById('clean-bar').style.width = cleanPercent + '%';
            
            const roomId = m.room || 'forest';
            const roomData = RoomDataManager.getRoomById(roomId);
            if (roomData && roomData.image) {
                document.querySelector('.monster-image .room-background').style.backgroundImage = `url('../datas/images/rooms/${roomData.image}.png')`;
            }
            
            const monsterSprite = document.querySelector('.monster-image .monster-sprite');
            const monsterData = MonsterDataManager.getMonsterById(m.id);
            if (monsterData && monsterData.image_name) {
                currentMonsterImageName = monsterData.image_name;
                monsterSprite.innerHTML = `<img src="../datas/images/monster/${monsterData.image_name}/${monsterData.image_name}_1.png" alt="${m.name}">`;
            } else if (m.image_emoji) {
                currentMonsterImageName = null;
                monsterSprite.innerHTML = '';
                monsterSprite.textContent = m.image_emoji;
            } else if (m.image_name) {
                currentMonsterImageName = m.image_name;
                monsterSprite.innerHTML = `<img src="../datas/images/monster/${m.image_name}/${m.image_name}_1.png" alt="${m.name}">`;
            } else {
                currentMonsterImageName = null;
                monsterSprite.innerHTML = '';
                monsterSprite.textContent = 'üêâ';
            }
            
            const hpPercent = ((m.hp || 0) / (m.maxhp || 1)) * 100;
            document.getElementById('hp-bar').style.width = hpPercent + '%';
            
            const expPercent = ((m.exp || 0) / (m.expToNextLevel || 1)) * 100;
            document.getElementById('exp-bar').style.width = expPercent + '%';
            
            if (typeof ElementDataManager !== 'undefined' && ElementDataManager.elements) {
                updateElementRibbons(m.element);
            } else {
                console.warn('ElementDataManager not loaded yet');
            }
            
            displayUnchi(m, isInitial || isFirstLoad);
            if (isInitial || isFirstLoad) {
                isFirstLoad = false;
            }
        }
        
        function updateElementRibbons(elementArray) {
            const ribbon1 = document.getElementById('element-ribbon-1');
            const ribbon2 = document.getElementById('element-ribbon-2');
            
            ribbon1.innerHTML = '';
            ribbon2.innerHTML = '';
            
            if (!elementArray || !Array.isArray(elementArray)) {
                return;
            }
            
            console.log('Element array[0]:', elementArray[0]);
            
            if (elementArray[0] !== null && elementArray[0] !== undefined) {
                const element1Data = ElementDataManager.getElementById(elementArray[0]);
                console.log('Element 1 data:', element1Data);
                if (element1Data) {
                    const iconData = ElementDataManager.resolveElementIcon(element1Data);
                    console.log('Element 1 iconData:', iconData);
                    if (iconData) {
                        ribbon1.innerHTML = iconData.type === 'emoji' ? iconData.content : `<img src="${iconData.content}" alt="${element1Data.element_name}">`;
                    }
                }
            }
            
            if (elementArray[1] !== null && elementArray[1] !== undefined) {
                const element2 = ElementDataManager.getElementById(elementArray[1]);
                if (element2) {
                    const iconData = ElementDataManager.resolveElementIcon(element2);
                    if (iconData) {
                        ribbon2.innerHTML = iconData.type === 'emoji' ? iconData.content : `<img src="${iconData.content}" alt="${element2.element_name}">`;
                    }
                }
            }
        }

        function updateSkillsDisplay(skills) {
            const skillsList = document.getElementById('skills-list');
            let html = '';
            
            if (skills && skills.length > 0) {
                skills.forEach(skill => {
                    html += `<div class="skill-item"><span class="skill-name">${skill.name}</span><span class="skill-desc">${skill.desc || 'ÁÑ°ÊèèËø∞'}</span></div>`;
                });
            }
            
            for (let i = (skills ? skills.length : 0); i < 4; i++) {
                html += `<div class="skill-item empty"><span class="skill-name">---</span><span class="skill-desc">Â∞öÊú™ÁøíÂæó</span></div>`;
            }
            
            skillsList.innerHTML = html;
        }

        function editMonsterName() {
            const data = getSaveData();
            if (data && data.monster) {
                const newName = prompt('Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÂØµÁâ©ÂêçÁ®±:', data.monster.name);
                if (newName && newName.trim() !== '') {
                    data.monster.name = newName.trim();
                    saveGame(data);
                    updateMonsterDisplay();
                }
            }
        }

        function feedMonster() {
            const data = getSaveData();
            if (!data || !data.monster) { alert('Ê≤íÊúâÂØµÁâ©Ë≥áÊñôÔºåË´ãÂÖàÂª∫Á´ãÂ≠òÊ™î'); return; }
            
            if (data.monster.stm >= 100) {
                ResultPopup.show('ÂØµÁâ©Â∑≤Á∂ìÈ£Ω‰∫ÜÔºÅ');
                return;
            }
            
            const currentTime = Date.now();
            const feedResetTime = data.monster.feed_reset_time || 0;
            
            if (currentTime < feedResetTime) {
                const remainingSeconds = Math.ceil((feedResetTime - currentTime) / 1000);
                ResultPopup.show(`ÂØµÁâ©ÈÇÑÊ≤íÈ§ìÔºÅ${remainingSeconds}ÁßíÂæåÂèØÈ§µÈ£ü`);
                return;
            }
            
            if (data.gold < 10) {
                alert('ÈáëÂπ£‰∏çË∂≥ÔºÅÈúÄË¶Å 10 ÈáëÂπ£');
                return;
            }
            
            const food = FoodDataManager.getRandomFood();
            if (!food) {
                alert('ÁÑ°Ê≥ïÂèñÂæóÈ£üÁâ©');
                return;
            }
            
            disableButtons();
            
            data.monster.feed_reset_time = currentTime + (1.5 * 60 * 1000);
            
            const goldCost = 10;
            
            GoldChangeAnimator.show(-goldCost);
            
            const monster_image_name = currentMonsterImageName;
            const food_image_name = food.image_folder;
            const max_frame = food.animation_frames - 1;
            
            let monster_index = 0;
            let food_index = 0;
            
            const monsterSprite = document.querySelector('.monster-image .monster-sprite img');
            
            function updateImages() {
                if (monsterSprite) {
                    monsterSprite.src = `../datas/images/monster/${monster_image_name}/${monster_image_name}_${monster_index}.png`;
                }
                FoodAnimator.updateFrame(food_index);
            }
            
            FoodAnimator.show(food_image_name);
            
            function playNext() {
                if (food_index >= max_frame) {
                    FoodAnimator.stop();
                    
                    const effects = FoodEffectParser.parse(food.food_effect);
                    const results = FoodEffectParser.apply(effects);
                    applyFeedResults(data, results);
                    return;
                }
                
                monster_index = 2;
                updateImages();
                
                setTimeout(() => {
                    monster_index = 1;
                    food_index++;
                    updateImages();
                    
                    setTimeout(playNext, 300);
                }, 300);
            }
            
            playNext();
            
            function applyFeedResults(data, results) {
                let resultTexts = [];
                
                for (const [stat, value] of Object.entries(results)) {
                    if (stat === 'hp') {
                        data.monster.hp = Math.min(data.monster.hp + value, data.monster.maxhp);
                        if (value > 0) resultTexts.push(`HP +${value}`);
                    } else if (stat === 'exp') {
                        data.monster.exp += value;
                        if (value > 0) resultTexts.push(`EXP +${value}`);
                    } else if (stat === 'stm') {
                        data.monster.stm = Math.min((data.monster.stm || 0) + value, 100);
                        if (value > 0) resultTexts.push(`È£ΩË∂≥ +${value}`);
                    }
                }
                
                data.gold -= goldCost;
                
                if (data.monster.exp >= data.monster.expToNextLevel) {
                    const levelUpResult = checkLevelUp(data.monster);
                    if (levelUpResult.leveledUp) {
                        levelUpResult.newStats = {
                            name: data.monster.name,
                            str: data.monster.str,
                            int: data.monster.int,
                            def: data.monster.def,
                            dex: data.monster.dex,
                            cha: data.monster.cha,
                            maxhp: data.monster.maxhp
                        };
                        saveGame(data);
                        showLevelUpPopup(levelUpResult, () => {
                            enableButtons();
                            updateMonsterDisplay();
                        });
                        return;
                    }
                }
                
                saveGame(data);
                
                document.getElementById('monster-hp').textContent = data.monster.hp;
                document.getElementById('monster-max-hp').textContent = data.monster.maxhp;
                document.getElementById('monster-exp').textContent = data.monster.exp;
                const expPercent = ((data.monster.exp || 0) / (data.monster.expToNextLevel || 1)) * 100;
                document.getElementById('exp-bar').style.width = expPercent + '%';
                document.getElementById('monster-level').textContent = data.monster.lv;
                document.getElementById('monster-exp-max').textContent = data.monster.expToNextLevel;
                document.getElementById('monster-stm').textContent = data.monster.stm || 100;
                document.getElementById('stm-bar').style.width = (data.monster.stm || 100) + '%';
                
                if (resultTexts.length > 0) {
                    ResultPopup.show(resultTexts.join(' '));
                }
                
                enableButtons();
            }
        }

        function bathMonster() {
            const data = getSaveData();
            if (!data || !data.monster) { alert('Ê≤íÊúâÂØµÁâ©Ë≥áÊñôÔºåË´ãÂÖàÂª∫Á´ãÂ≠òÊ™î'); return; }
            
            if (data.monster.clean >= 100) {
                ResultPopup.show('ÂØµÁâ©Â∑≤Á∂ìÂæà‰πæÊ∑®‰∫ÜÔºÅ');
                return;
            }
            
            data.monster.clean = 100;
            const affectionGain = Math.floor(Math.random() * 5) + 1;
            const leveledUp = addAffection(data.monster, affectionGain);
            
            saveGame(data);
            updateMonsterDisplay();
            
            let resultText = `Â•ΩÊÑüÂ∫¶ +${affectionGain}`;
            if (leveledUp) {
                resultText += ' Â•ΩÊÑüÂ∫¶ÂçáÁ¥öÔºÅ';
            }
            ResultPopup.show(resultText);
        }

        function toiletMonster() {
            const data = getSaveData();
            if (!data || !data.monster) { alert('Ê≤íÊúâÂØµÁâ©Ë≥áÊñôÔºåË´ãÂÖàÂª∫Á´ãÂ≠òÊ™î'); return; }
            
            const unchiCount = data.monster.unchi || 0;
            
            if (unchiCount <= 0) {
                ResultPopup.show('Ê≤íÊúâÂ§ß‰æøÈúÄË¶ÅÊ∏ÖÁêÜÔºÅ');
                return;
            }
            
            let affectionTotal = 0;
            let expTotal = 0;
            
            for (let i = 0; i < unchiCount; i++) {
                affectionTotal += Math.floor(Math.random() * 4) + 2;
                expTotal += Math.floor(Math.random() * 16) + 10;
            }
            data.monster.unchi = 0;
            
            if (affectionTotal > 0) {
                data.monster.affection_exp = (data.monster.affection_exp || 0) + affectionTotal;
            }
            
            const leveledUp = checkAffectionLevelUp(data.monster);
            
            if (expTotal > 0) {
                data.monster.exp = (data.monster.exp || 0) + expTotal;
                const expLevelUpResult = checkLevelUp(data.monster);
                if (expLevelUpResult.leveledUp) {
                    expLevelUpResult.newStats = {
                        name: data.monster.name,
                        str: data.monster.str,
                        int: data.monster.int,
                        def: data.monster.def,
                        dex: data.monster.dex,
                        cha: data.monster.cha,
                        maxhp: data.monster.maxhp
                    };
                    saveGame(data);
                    updateMonsterDisplay();
                    showLevelUpPopup(expLevelUpResult, () => {
                        updateMonsterDisplay();
                    });
                    return;
                }
            }
            
            saveGame(data);
            updateMonsterDisplay();
            
            let resultText = `Ê∏ÖÁêÜ‰∫Ü${unchiCount}ÂÄãÂ§ß‰æøÔºÅ`;
            resultText += ` Â•ΩÊÑüÂ∫¶ +${affectionTotal}ÔºåÁ∂ìÈ©óÂÄº +${expTotal}`;
            if (leveledUp) {
                resultText += ' Â•ΩÊÑüÂ∫¶ÂçáÁ¥öÔºÅ';
            }
            ResultPopup.show(resultText);
        }

        function interactMonster() {
            const data = getSaveData();
            if (!data || !data.monster) { alert('Ê≤íÊúâÂØµÁâ©Ë≥áÊñôÔºåË´ãÂÖàÂª∫Á´ãÂ≠òÊ™î'); return; }
            data.monster.exp += 3;
            const levelUpResult = checkLevelUp(data.monster);
            saveGame(data);
            
            if (levelUpResult.leveledUp) {
                levelUpResult.newStats = {
                    name: data.monster.name,
                    str: data.monster.str,
                    int: data.monster.int,
                    def: data.monster.def,
                    dex: data.monster.dex,
                    cha: data.monster.cha,
                    maxhp: data.monster.maxhp
                };
                showLevelUpPopup(levelUpResult, () => {
                    updateMonsterDisplay();
                });
            } else {
                alert('‰∫íÂãïÊàêÂäüÔºÅÁç≤Âæó 3 Á∂ìÈ©óÂÄº');
                updateMonsterDisplay();
            }
        }

        function huntMonster() {
            const data = getSaveData();
            if (!data || !data.monster) { alert('Ê≤íÊúâÂØµÁâ©Ë≥áÊñôÔºåË´ãÂÖàÂª∫Á´ãÂ≠òÊ™î'); return; }
            window.location.href = 'Battle.html';
        }

        function showSkillsModal() {
            const data = getSaveData();
            if (!data || !data.monster) { alert('Ê≤íÊúâÂØµÁâ©Ë≥áÊñôÔºåË´ãÂÖàÂª∫Á´ãÂ≠òÊ™î'); return; }
            
            const skillIds = data.monster.skill_id || [];
            const skills = [];
            skillIds.forEach(skillId => {
                const skill = SkillDataManager.getSkillById(skillId);
                if (skill) skills.push(skill);
            });
            
            const pageSize = 6;
            let currentPage = 0;
            const totalPages = Math.ceil(skills.length / pageSize) || 1;
            
            function renderSkillsPage(page) {
                const start = page * pageSize;
                const end = Math.min(start + pageSize, skills.length);
                const pageSkills = skills.slice(start, end);
                
                let modalContent = '<div id="skills-modal-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;display:flex;justify-content:center;align-items:center;">';
                modalContent += '<div class="skills-modal-content">';
                modalContent += '<h3 class="skills-modal-title">ÊäÄËÉΩÂàóË°®</h3>';
                
                if (skills.length > 0) {
                    for (let i = 0; i < pageSize; i++) {
                        if (i < pageSkills.length) {
                            const skill = pageSkills[i];
                            const iconUrl = getSkillIconUrl(skill);
                            modalContent += `<div class="skill-item">`;
                            modalContent += `<div class="skill-name-row">`;
                            modalContent += `<img src="${iconUrl.url}" class="skill-icon">`;
                            modalContent += `<span class="skill-name">${skill.name}</span>`;
                            modalContent += `</div>`;
                            modalContent += `<div class="skill-desc-row">${skill.description || 'ÁÑ°ÊèèËø∞'}</div>`;
                            modalContent += `</div>`;
                        } else {
                            modalContent += `<div class="skill-item empty">`;
                            modalContent += `<div class="skill-name-row">`;
                            modalContent += `<div class="skill-icon"></div>`;
                            modalContent += `<span class="skill-name-empty">---</span>`;
                            modalContent += `</div>`;
                            modalContent += `<div class="skill-desc-row"></div>`;
                            modalContent += `</div>`;
                        }
                    }
                } else {
                    modalContent += '<div style="color:#888;text-align:center;padding:20px;">Â∞öÊú™ÁøíÂæó‰ªª‰ΩïÊäÄËÉΩ</div>';
                }
                
                if (totalPages > 1) {
                    modalContent += `<div class="skills-pagination">`;
                    modalContent += `<button id="skills-prev-btn" class="page-btn" ${page === 0 ? 'disabled' : ''}>‚óÄ</button>`;
                    modalContent += `<span class="page-info">${page + 1} / ${totalPages}</span>`;
                    modalContent += `<button id="skills-next-btn" class="page-btn" ${page >= totalPages - 1 ? 'disabled' : ''}>‚ñ∂</button>`;
                    modalContent += `</div>`;
                }
                
                modalContent += `<button id="close-skills-modal" class="close-btn">ÈóúÈñâ</button>`;
                modalContent += '</div></div>';
                
                document.body.insertAdjacentHTML('beforeend', modalContent);
                
                document.getElementById('close-skills-modal').addEventListener('click', function() {
                    document.getElementById('skills-modal-overlay').remove();
                });
                
                document.getElementById('skills-modal-overlay').addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.remove();
                    }
                });
                
                if (totalPages > 1) {
                    document.getElementById('skills-prev-btn').addEventListener('click', function() {
                        if (page > 0) {
                            document.getElementById('skills-modal-overlay').remove();
                            currentPage = page - 1;
                            renderSkillsPage(currentPage);
                        }
                    });
                    
                    document.getElementById('skills-next-btn').addEventListener('click', function() {
                        if (page < totalPages - 1) {
                            document.getElementById('skills-modal-overlay').remove();
                            currentPage = page + 1;
                            renderSkillsPage(currentPage);
                        }
                    });
                }
            }
            
            renderSkillsPage(currentPage);
        }

        function getSkillIconUrl(skill) {
            let iconFile = '../datas/images/ui/element_icons.png';
            
            if (skill.systemIcon) {
                iconFile = `../datas/images/ui/${skill.systemIcon}.png`;
            }
            
            return { url: iconFile };
        }

        document.getElementById('nav-training').addEventListener('click', function() { window.location.href = 'Training.html'; });
        document.getElementById('nav-hunt').addEventListener('click', function() { window.location.href = 'Battle.html'; });
        document.getElementById('nav-gacha').addEventListener('click', function() { alert('ËΩâËõãÂäüËÉΩÂ∞öÊú™ÈñãÊîæ'); });
        document.getElementById('nav-system').addEventListener('click', function() { window.location.href = 'System.html'; });

        document.getElementById('btn-edit-name').addEventListener('click', editMonsterName);
        
        let isActionInProgress = false;
        function disableButtons() {
            if (isActionInProgress) return true;
            isActionInProgress = true;
            document.getElementById('btn-feed').disabled = true;
            document.getElementById('btn-bath').disabled = true;
            document.getElementById('btn-clean').disabled = true;
            document.getElementById('btn-interact').disabled = true;
            return false;
        }
        
        function enableButtons() {
            isActionInProgress = false;
            document.getElementById('btn-feed').disabled = false;
            document.getElementById('btn-bath').disabled = false;
            document.getElementById('btn-clean').disabled = false;
            document.getElementById('btn-interact').disabled = false;
        }
        
        function disableButtonsTemporarily() {
            if (isActionInProgress) return true;
            isActionInProgress = true;
            document.getElementById('btn-feed').disabled = true;
            document.getElementById('btn-bath').disabled = true;
            document.getElementById('btn-clean').disabled = true;
            document.getElementById('btn-interact').disabled = true;
            setTimeout(() => {
                enableButtons();
            }, 1500);
            return false;
        }
        
        document.getElementById('btn-feed').addEventListener('click', function() {
            feedMonster();
        });
        document.getElementById('btn-bath').addEventListener('click', function() {
            if (disableButtonsTemporarily()) return;
            bathMonster();
        });
        document.getElementById('btn-clean').addEventListener('click', function() {
            if (disableButtonsTemporarily()) return;
            toiletMonster();
        });
        document.getElementById('btn-interact').addEventListener('click', function() {
            if (disableButtonsTemporarily()) return;
            interactMonster();
        });
        document.getElementById('btn-skills').addEventListener('click', showSkillsModal);
        document.getElementById('btn-evolve').addEventListener('click', function() {
            alert('ÈÄ≤ÂåñÂäüËÉΩÂ∞öÊú™ÈñãÊîæ');
        });
        document.getElementById('btn-room').addEventListener('click', showRoomModal);

        function showRoomModal() {
            const data = getSaveData();
            if (!data || !data.monster) { alert('Ê≤íÊúâÂØµÁâ©Ë≥áÊñôÔºåË´ãÂÖàÂª∫Á´ãÂ≠òÊ™î'); return; }
            
            const openRooms = data.openRooms || [];
            const currentRoom = data.monster.room || '';
            
            if (openRooms.length === 0) {
                alert('Â∞öÊú™Ëß£Èéñ‰ªª‰ΩïÊàøÈñì');
                return;
            }
            
            const rooms = openRooms.map(roomId => RoomDataManager.getRoomById(roomId)).filter(r => r !== null);
            let currentIndex = rooms.findIndex(r => r.roomId === currentRoom);
            if (currentIndex === -1) currentIndex = 0;
            
            function renderRoomPage(index) {
                const room = rooms[index];
                const isSet = room.roomId === currentRoom;
                const roomImageUrl = `../datas/images/rooms/${room.image}.png`;
                
                let modalContent = '<div id="room-modal-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;display:flex;justify-content:center;align-items:center;">';
                modalContent += '<div class="skills-modal-content">';
                modalContent += `<div class="room-display">`;
                modalContent += `<div class="room-title">ÊàøÈñìË®≠ÁΩÆ</div>`;
                modalContent += `<div class="room-image">`;
                modalContent += `<div class="room-name">${room.name}</div>`;
                modalContent += `<img src="${roomImageUrl}" class="room-img">`;
                modalContent += `</div>`;
                modalContent += `<div class="room-nav">`;
                modalContent += `<button id="sub-prev-btn" class="page-btn" ${index === 0 ? 'disabled' : ''}>‚óÄ</button>`;
                modalContent += `<button id="room-set-btn" class="room-set-btn" ${isSet ? 'disabled' : ''}>${isSet ? 'Â∑≤Ë®≠ÂÆö' : 'Ë®≠ÂÆö'}</button>`;
                modalContent += `<button id="sub-next-btn" class="page-btn" ${index >= rooms.length - 1 ? 'disabled' : ''}>‚ñ∂</button>`;
                modalContent += `</div>`;
                modalContent += `<button id="sub-close-btn" class="close-btn">ÈóúÈñâ</button>`;
                modalContent += `</div>`;
                modalContent += '</div></div>';
                
                document.body.insertAdjacentHTML('beforeend', modalContent);
                
                document.getElementById('sub-close-btn').addEventListener('click', function() {
                    document.getElementById('room-modal-overlay').remove();
                });
                
                document.getElementById('room-modal-overlay').addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.remove();
                    }
                });
                
                if (rooms.length > 1) {
                    document.getElementById('sub-prev-btn').addEventListener('click', function() {
                        if (index > 0) {
                            document.getElementById('room-modal-overlay').remove();
                            renderRoomPage(index - 1);
                        }
                    });
                    
                    document.getElementById('sub-next-btn').addEventListener('click', function() {
                        if (index < rooms.length - 1) {
                            document.getElementById('room-modal-overlay').remove();
                            renderRoomPage(index + 1);
                        }
                    });
                }
                
                document.getElementById('room-set-btn').addEventListener('click', function() {
                    if (!isSet) {
                        data.monster.room = room.roomId;
                        saveGame(data);
                        document.getElementById('room-modal-overlay').remove();
                        showRoomModal();
                    }
                });
            }
            
            renderRoomPage(currentIndex);
        }

        document.getElementById('btn-dev').addEventListener('click', function() {
            if (checkSaveExists()) {
                const data = getSaveData();
                alert('Â≠òÊ™îÂ≠òÂú®ÔºÅ\nÈáëÂπ£: ' + data.gold);
            } else {
                alert('Â≠òÊ™î‰∏çÂ≠òÂú®');
            }
        });

        window.devmode = function() {
            document.getElementById('btn-dev').style.display = 'block';
            console.log('Dev mode enabled');
        };

        setInterval(() => {
            const data = getSaveData();
            if (data && data.monster) {
                decreaseStmAndClean(data.monster);
                saveGame(data);
                updateMonsterDisplay();
            }
        }, 10000);
        
        initGameData().then(() => { 
            updateMonsterDisplay(true);
            GameNavigation.init('Training');
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('../service-worker.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>
</body>
</html>
